var gem=[],cluster=[],size=18,minLine=3,colors=6,chosen=!1,diagonal=!0,field=$("#field"),pause=!0,linesOnly=!1,score=0,target=0,time=60;function init(e,a,t){field.html(""),createMap(e,t),fillMap()}function kill(e){var a=e;e=[],0!==a.length?(score+=a.length*a.length*36,console.log(score),pause=!0,setTimeout((function(){for(var e=0;e<a.length;e++)gem[a[e].j][a[e].k].kill()}),300),setTimeout((function(){for(var e=0;e<a.length;e++)shiftDown(a[e].j,a[e].k)}),600),setTimeout((function(){for(j=0;j<size;j++)for(k=0;k<size;k++)e=e.concat(matchChain(j,k));kill(e)}),600)):(setTimeout("fillMap()",600),pause=!1)}function createMap(e,a){if(e>1&&(1==linesOnly&&a>1||0==linesOnly&&a>1)&&minLine>1){for(var t=0;t<e;t++){gem[t]=[];for(var l=0;l<e;l++)gem[t][l]=0}for(l=0;l<e;l++)for(k=0;k<e;k++)gem[l][k]={elem:"",state:"dead",color:"",kill:function(){this.state="dead",this.elem.addClass("dead"),this.elem.css({left:500*Math.random()+"px",top:"250px"})},place:function(){this.elem.css({top:500*this.elem.data("j")/e,left:500*this.elem.data("k")/e})}},field.append('<div class="gem" data-j="'+l+'" data-k="'+k+'" + data-color="" ></div>'),gem[l][k].elem=$("[data-j="+l+"][data-k="+k+"]");gemClass=$(".gem"),gemClass.css({width:500/e-1+"px",height:500/e-1+"px","font-size":500/(2*e)+"px"})}else field.html("A field with the following parameters: size: "+e+", colors: "+a+", min. line length: "+minLine+",  cannot be generated.")}function fillMap(){var e;for(pause=!0,j=0;j<size;j++)for(k=0;k<size;k++)if("dead"==gem[j][k].state){gem[j][k].state="alive",gem[j][k].elem.removeClass("dead");do{e=Math.floor(Math.random()*colors),gem[j][k].color=e,cluster=matchChain(j,k,"check")}while(0!==cluster.length);switch(gem[j][k].elem.data("color",gem[j][k].color).attr("data-color",gem[j][k].color),gem[j][k].elem.css({left:500*k/size+"px",top:500*(size-j)/size*-1-50+"px"}),e){case 0:gem[j][k].elem.html("⚜");break;case 1:gem[j][k].elem.html("☣");break;case 2:gem[j][k].elem.html("♗");break;case 3:gem[j][k].elem.html("♆ ");break;case 4:gem[j][k].elem.html("♞");break;case 5:gem[j][k].elem.html("♙");break;case 6:gem[j][k].elem.html("☄");break;case 7:gem[j][k].elem.html("❦");break;case 8:gem[j][k].elem.html("♨");break;case 9:gem[j][k].elem.html("♟")}}setTimeout("place()",600),pause=!1}function shiftDown(e,a){for(var t=0;t<=e;t++)for(var l=e;l>0;l--)"dead"===gem[l][a].state&&(swap(l,a,l-1,a),gem[l-1][a].place(),gem[l][a].place())}function swap(e,a,t,l){var o;o=gem[e][a],gem[e][a]=gem[t][l],gem[t][l]=o,gem[t][l].elem.data({j:t,k:l}).attr({"data-j":t,"data-k":l}),gem[e][a].elem.data({j:e,k:a}).attr({"data-j":e,"data-k":a})}function correctTurn(e,a,t,l){var o=!1;return e!==cj&&l!==ck&&(o=!0),e==t+1&&a==l&&(o=!0),e==t-1&&a==l&&(o=!0),e==t&&a==l+1&&(o=!0),e==t&&a==l-1&&(o=!0),1==diagonal&&(e==t+1&&a==l+1&&(o=!0),e==t-1&&a==l-1&&(o=!0),e==t-1&&a==l+1&&(o=!0),e==t+1&&a==l-1&&(o=!0)),gem[e][a].color==gem[t][l].color&&(o=!1),o}function place(){for(var e=size-1;e>=0;e--)for(var a=size-1;a>=0;a--)gem[e][a].place()}function matchChain(e,a,t){var l=new Array,o=new Array,s=new Array,m=0;if("dead"!==gem[e][a].state){if(gem[e][a].state="dead",0==linesOnly)for(l.push({j:e,k:a}),m=0;m<l.length;m++)l[m].j>0&&gem[l[m].j-1][l[m].k].color==gem[l[m].j][l[m].k].color&&"dead"!==gem[l[m].j-1][l[m].k].state&&(l.push({j:l[m].j-1,k:l[m].k}),gem[l[m].j-1][l[m].k].state="dead"),l[m].k>0&&gem[l[m].j][l[m].k-1].color==gem[l[m].j][l[m].k].color&&"dead"!==gem[l[m].j][l[m].k-1].state&&(l.push({j:l[m].j,k:l[m].k-1}),gem[l[m].j][l[m].k-1].state="dead"),l[m].j<size-1&&gem[l[m].j+1][l[m].k].color==gem[l[m].j][l[m].k].color&&"dead"!==gem[l[m].j+1][l[m].k].state&&(l.push({j:l[m].j+1,k:l[m].k}),gem[l[m].j+1][l[m].k].state="dead"),l[m].k<size-1&&gem[l[m].j][l[m].k+1].color==gem[l[m].j][l[m].k].color&&"dead"!==gem[l[m].j][l[m].k+1].state&&(l.push({j:l[m].j,k:l[m].k+1}),gem[l[m].j][l[m].k+1].state="dead");else{for(o.push({j:e,k:a}),s.push({j:e,k:a}),m=0;m<o.length;m++)o[m].k>0&&gem[o[m].j][o[m].k-1].color==gem[o[m].j][o[m].k].color&&"dead"!==gem[o[m].j][o[m].k-1].state&&(o.push({j:o[m].j,k:o[m].k-1}),gem[o[m].j][o[m].k-1].state="dead"),o[m].k<size-1&&gem[o[m].j][o[m].k+1].color==gem[o[m].j][o[m].k].color&&"dead"!==gem[o[m].j][o[m].k+1].state&&(o.push({j:o[m].j,k:o[m].k+1}),gem[o[m].j][o[m].k+1].state="dead");for(m=0;m<s.length;m++)s[m].j>0&&gem[s[m].j-1][s[m].k].color==gem[s[m].j][s[m].k].color&&"dead"!==gem[s[m].j-1][s[m].k].state&&(s.push({j:s[m].j-1,k:s[m].k}),gem[s[m].j-1][s[m].k].state="dead"),s[m].j<size-1&&gem[s[m].j+1][s[m].k].color==gem[s[m].j][s[m].k].color&&"dead"!==gem[s[m].j+1][s[m].k].state&&(s.push({j:s[m].j+1,k:s[m].k}),gem[s[m].j+1][s[m].k].state="dead")}if(l.length<minLine){for(m=0;m<l.length;m++)gem[l[m].j][l[m].k].state="alive";l=[]}if(o.length<minLine){for(m=0;m<o.length;m++)gem[o[m].j][o[m].k].state="alive";o=[]}if(s.length<minLine){for(m=0;m<s.length;m++)gem[s[m].j][s[m].k].state="alive";s=[]}if(1==linesOnly&&(l=o.concat(s)),"check"==t)for(m=0;m<l.length;m++)gem[l[m].j][l[m].k].state="alive"}return l}function leveler(e){if(target=Math.floor(5e3*Math.sqrt(e)),size=Math.floor(5*Math.random())+12,10!==colors&&colors++,e>=2){var a=2*Math.random();linesOnly=1!=a}e>=3&&(a=2*Math.random(),diagonal=1!=a),field.html("Level "+e),1==linesOnly?field.append(levelinfo.nocluster):field.append(levelinfo.cluster),1==diagonal?field.append(levelinfo.diagonal):field.append(levelinfo.nodiagonal),time=60+Math.floor(5*e/2),setTimeout("init(size, minLine, colors)",1e3)}scoreboard=$("#scoreboard"),level=1,levelinfo={diagonal:'<img src="img/diagonal.png">',nodiagonal:'<img src="img/no-diagonal.png">',cluster:'<img src="img/cluster.png">',nocluster:'<img src="img/no-cluster.png">'},$(document).ready(leveler(level)),field.on("click",".gem",(function(){if(0==chosen&&!0!==pause)chosen=!0,cj=$(this).data("j"),ck=$(this).data("k"),console.log(cj+"x"+ck+", "+gem[cj][ck].color+", "+gem[cj][ck].state),gem[cj][ck].elem.addClass("chosen");else if(!0!==pause){chosen=!1;var e=$(this).data("j"),a=$(this).data("k");1==correctTurn(cj,ck,e,a)?(gem[cj][ck].elem.removeClass("chosen"),swap(cj,ck,e,a),gem[cj][ck].place(),gem[e][a].place(),0===(cluster=(cluster=matchChain(cj,ck)).concat(matchChain(e,a))).length?setTimeout((function(){swap(e,a,cj,ck),gem[cj][ck].place(),gem[e][a].place()}),500):kill(cluster)):gem[cj][ck].elem.removeClass("chosen")}}));var countdown=setInterval((function(){0==time&&score<target?(clearInterval(countdown),field.html("Game over"),scoreboard.html(score+"/"+target+" | <span> 0 </span>")):0==time&&score>=target?(level++,score=0,leveler(level)):(time-=1,scoreboard.html(score+"/"+target+" | "+time))}),1e3);